{% extends "base.html" %}

{% block title %}Смена пароля - Мессенджер{% endblock %}

{% block content %}
<style>
    .app-container, .sidebar, .main-content { display: none; }

    .security-page {
        min-height: 100vh;
        background: var(--bg-primary);
        display: flex;
        align-items: flex-start;
        justify-content: center;
    }

    .security-card {
        background: var(--bg-secondary);
        width: 100%;
        max-width: 560px;
        min-height: 100vh;
    }

    .security-header {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
        z-index: 10;
    }

    .back-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: transparent;
        border: none;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        text-decoration: none;
        flex-shrink: 0;
        transition: background 0.2s;
    }
    .back-btn:hover { background: var(--bg-tertiary); }

    .security-header h1 {
        font-size: 19px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .section {
        padding: 20px 16px 0;
    }

    .section-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.7px;
        margin-bottom: 12px;
        padding: 0 4px;
    }

    .section-card {
        background: var(--bg-tertiary);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .password-form {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .field-wrap {
        position: relative;
    }

    .field-wrap label {
        display: block;
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 6px;
        font-weight: 600;
    }

    .field-wrap input {
        width: 100%;
        padding: 13px 44px 13px 14px;
        background: var(--bg-secondary);
        border: 1.5px solid var(--border);
        border-radius: 12px;
        color: var(--text-primary);
        font-size: 15px;
        box-sizing: border-box;
        transition: border-color 0.2s;
        font-family: inherit;
    }

    .field-wrap input:focus {
        outline: none;
        border-color: var(--accent);
    }

    .toggle-pw {
        position: absolute;
        right: 12px;
        bottom: 13px;
        cursor: pointer;
        color: var(--text-muted);
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
    }

    .strength-bar {
        display: flex;
        gap: 4px;
        margin-top: 6px;
    }

    .strength-bar span {
        flex: 1;
        height: 3px;
        border-radius: 2px;
        background: var(--border);
        transition: background 0.3s;
    }

    .strength-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .pw-save-btn {
        width: 100%;
        padding: 14px;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.15s;
        margin-top: 4px;
        font-family: inherit;
    }
    .pw-save-btn:hover  { opacity: 0.88; }
    .pw-save-btn:active { transform: scale(0.97); }

    .pw-message {
        display: none;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
    }
    .pw-message.error   { background: rgba(239,68,68,.15); color: #f87171; }
    .pw-message.success { background: rgba(34,197,94,.15);  color: #4ade80; }

    @media (max-width: 560px) {
        .security-card { max-width: 100%; }
    }
</style>

<div class="security-page">
<div class="security-card">

    <div class="security-header">
        <a href="{{ url_for('security') }}" class="back-btn" title="Назад">
            <svg width="22" height="22" viewBox="0 0 1024 1024">
                <use xlink:href="#icon-back"></use>
            </svg>
        </a>
        <h1>Пароль</h1>
    </div>

    <div class="section" style="margin-top: 20px;">
        <div class="section-title">Смена пароля</div>
        <div class="section-card">
            <div class="password-form">
                <div id="pwMessage" class="pw-message"></div>

                <div class="field-wrap">
                    <label>Текущий пароль</label>
                    <input type="password" id="currentPassword" placeholder="Введите текущий пароль" autocomplete="current-password">
                    <button type="button" class="toggle-pw" onclick="togglePw('currentPassword', this)" tabindex="-1">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>

                <div class="field-wrap">
                    <label>Новый пароль</label>
                    <input type="password" id="newPassword" placeholder="Минимум 8 символов" autocomplete="new-password" oninput="checkStrength(this.value)">
                    <button type="button" class="toggle-pw" onclick="togglePw('newPassword', this)" tabindex="-1">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                    <div class="strength-bar">
                        <span id="s1"></span><span id="s2"></span>
                        <span id="s3"></span><span id="s4"></span>
                    </div>
                    <div class="strength-label" id="strengthLabel"></div>
                </div>

                <div class="field-wrap">
                    <label>Повторите новый пароль</label>
                    <input type="password" id="confirmPassword" placeholder="Повторите пароль" autocomplete="new-password">
                    <button type="button" class="toggle-pw" onclick="togglePw('confirmPassword', this)" tabindex="-1">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>

                <button class="pw-save-btn" onclick="changePassword()">Сохранить пароль</button>
            </div>
        </div>
    </div>

</div>
</div>

<script>
function togglePw(fieldId, btn) {
    const inp = document.getElementById(fieldId);
    const isText = inp.type === 'text';
    inp.type = isText ? 'password' : 'text';
    btn.style.opacity = isText ? '1' : '0.5';
}

function checkStrength(pw) {
    const bars  = ['s1','s2','s3','s4'];
    const label = document.getElementById('strengthLabel');
    let score = 0;
    if (pw.length >= 8)  score++;
    if (pw.length >= 12) score++;
    if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
    if (/\d/.test(pw) && /[^A-Za-z0-9]/.test(pw)) score++;
    const colors  = ['#f87171','#fb923c','#facc15','#4ade80'];
    const labels  = ['Очень слабый','Слабый','Хороший','Надёжный'];
    bars.forEach((id, i) => {
        document.getElementById(id).style.background = i < score ? colors[score - 1] : 'var(--border)';
    });
    label.textContent = pw.length ? labels[score - 1] || '' : '';
    label.style.color = score ? colors[score - 1] : 'var(--text-muted)';
}

function showMsg(text, type) {
    const el = document.getElementById('pwMessage');
    el.textContent = text;
    el.className = `pw-message ${type}`;
    el.style.display = 'block';
    if (type === 'success') setTimeout(() => { el.style.display = 'none'; }, 4000);
}

function changePassword() {
    const current  = document.getElementById('currentPassword').value;
    const newPw    = document.getElementById('newPassword').value;
    const confirm  = document.getElementById('confirmPassword').value;
    if (!current || !newPw || !confirm) return showMsg('Заполните все поля', 'error');
    if (newPw !== confirm) return showMsg('Новые пароли не совпадают', 'error');
    if (newPw.length < 8) return showMsg('Пароль должен быть минимум 8 символов', 'error');
    const btn = document.querySelector('.pw-save-btn');
    btn.disabled = true;
    btn.textContent = 'Сохраняем...';
    const form = new FormData();
    form.append('current_password', current);
    form.append('new_password', newPw);
    form.append('confirm_password', confirm);
    fetch('/security/change_password', { method: 'POST', body: form })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showMsg('✓ Пароль успешно изменён', 'success');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                checkStrength('');
            } else {
                showMsg(data.error || 'Ошибка при смене пароля', 'error');
            }
        })
        .catch(() => showMsg('Ошибка соединения', 'error'))
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Сохранить пароль';
        });
}
</script>
{% endblock %}
